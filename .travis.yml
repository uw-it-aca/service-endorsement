sudo: required

language: python
python:
  - 3.6

services:
  - docker

os:
  - linux

env:
  global:
    - RELEASE_NAME="prt"
    - DJANGO_APP="endorsement"
    - COMMIT_HASH="$(git rev-parse --short=7 HEAD)"
    - IMAGE_TAG="${RELEASE_NAME}:${COMMIT_HASH}"
    - DEPLOY_SCRIPT_BASE=https://raw.githubusercontent.com/uw-it-aca/gcp-app-deploy/
#    - DEPLOY_SCRIPT_BRANCH=master
    - DEPLOY_SCRIPT_BRANCH=feature/gcr
    - DEPLOY_SCRIPT=${DEPLOY_SCRIPT_BASE}/${DEPLOY_SCRIPT_BRANCH}/travis-ci/deploy.sh
    - GCP_JSON_KEY=gcp.json
    - secure: "ctvBOu0ryfQU0aHoMz2AScokqL5qpOpIam1I5B5uGjnk5iyc9RCgYVmev081zc04KZOZ250XDvmtwivGRsntlDge9xD6i7CHkNAezhQsRK78sVZPLLmV6UVZLKCeFWCv4m/t2rpdR0YR7CFMMz8iLkhapnr9WAFmfg6nRn1Jm7N4hwojSZzjf2Efq0W1tbTyZUsv4wA9cSSb6QwKFPHhcO+TxjrZqX6GF9l1b7Cod6PbrvzWBKF0uMkwIuEkC6JSPQPudemqlRNbM7KrMN4wD8XkYCNTd1etm2R2wKFdox2tf8vNv6UxRTyRnwmB0SUc93MeEzMMTY+XTH9DjN2K1bejQbOpntByCKtuyavuXUEqI8840xZvQlgwYR+eQcWQlsFz/CsRGU0SeivxWf5MkVl1uaZQI7jI8cYtk3x3SDgHDIhifLc+ItcrxsyQASAPKpouvvzexzn1DdOLfTqx6CIa369srVdZSV3Zhsrw5Eu25nTTNv5DkEGio9G9+0UeD5AoC5z08n8ht9Q3w0FQ7OrjBm1TIf8XXAi8AObwLFWuvFGzpWLNzIKFMLBKBNVoEDkSmzTJqEfIiqp/fVpNrENUtimqUkGg3x8KpP2ONLNW9GPXKuGM39vHC01NkrmVCLJBa4xtkS1UTndMq632t7TmgxTZ2F9RNOtaqOP8clI="

install:
  - docker build --target app-container -t "$IMAGE_TAG" .
  - docker build -t app-test-container .

before_script:
  - pip install coverage
  - pip install coveralls

script:
  - docker run -u root -it -v /tmp:/coverage -e DJANGO_APP="$DJANGO_APP" -e "ENV=localdev" -e "AUTH=SAML_MOCK" app-test-container bash -c ". ./travis-ci/test.sh"

after_success:
  - cp /tmp/.coverage.* .
  - coverage combine
  - coveralls
  - openssl aes-256-cbc -K $encrypted_0e718fcdeb51_key -iv $encrypted_0e718fcdeb51_iv -in ${GCP_JSON_KEY}.enc -out ${GCP_JSON_KEY} -d

deploy:
  - provider: script
    skip_cleanup: true
    script: >-
      curl -Ls "$DEPLOY_SCRIPT" | bash
    on:
      all_branches: true
      condition: >-
        $TRAVIS_PULL_REQUEST == "false" &&
        $TRAVIS_BRANCH =~ ^(master|develop)$
